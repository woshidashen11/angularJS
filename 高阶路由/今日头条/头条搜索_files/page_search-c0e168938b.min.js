$(function(){function e(){this.init()}FastClick.attach(document.body);var t="http://minisearch.dfshurufa.com/hotwords/hotwords",a="http://minisearch.dfshurufa.com/search_all/search",s=GLOBAL.Et.ggForPullUp.concat(),i=!0,r=$("#J_search_btn"),o=$("#J_search_input"),n=$("#J_hot_words"),c=$("#J_news_wrap"),l=$('<div class="list-block news-list-wrap"></div>'),d=$('<div id="J_loading" class="loading"><div class="spinner"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div><p class="txt">数据加载中</p></div>'),p=0,g=GLOBAL.Util.getQueryString("kw"),h=g,m=!0,u=null,f=new WebStorageCache;e.prototype={init:function(){var e=this;c.append(l).append(d),f.get("search_hotwords")?n.html(f.get("search_hotwords")):e.loadHotWords(),n.on("click","a",function(){e.clearCaches(),h=$(this).text(),e.load()}),$(window).on("scroll",function(){var t=GLOBAL.Util.getScrollTop(),a=d.offset().top,s=GLOBAL.Util.getClientHeight();a>=s&&t+s>=a&&m&&h?(m=!1,i=!1,e.loadSearchData(h)):a<s&&d.hide()}),r.on("click",function(t){var a=$(this);a.hasClass("cancel")?(o.val("").focus(),e.clearContent()):(h=$.trim(o.val()),h&&e.load()),e.updateBtnStatus(),t.preventDefault()}),o.on("keyup",function(t){u&&clearTimeout(u),u=setTimeout(function(){h=$.trim(o.val()),h||(e.clearContent(),e.updateBtnStatus())},300),13===t.keyCode&&(h=$.trim(o.val()),h&&e.load(),e.updateBtnStatus())});try{if(g)o.val(g),l.html(""),e.clearCaches(),e.loadSearchData(g);else{h=f.get("search_kw");var t=f.get("search_content");h&&t&&o.val(h),f.get("search_content")?(n.hide(),c.show(),l.html(t),e.hideOfShowLoading(),f.set("search_content",t,{exp:600})):(n.show(),c.hide(),f["delete"]("search_kw"))}e.cacheKw()}catch(a){}e.updateBtnStatus(),l.on("click","a",function(){var t=$(this).attr("href");t=t.substring(t.lastIndexOf("/")+1,t.indexOf(".html")),e.cacheReadUrl(t)})},load:function(){var e=window.location.search,t=window.location.protocol+"//"+window.location.port+window.location.hostname+window.location.pathname;"?"===h&&(h=""),"kw"===h||"="===h?window.location.href=encodeURI(t+"?kw="+h):g&&e.indexOf(g)>-1?window.location.href=encodeURI(t+e.replace(g,h)):window.location.href=encodeURI(t+"?kw="+h)},insertGgForPullUp:function(e){try{if(GLOBAL.Et.gg.my.nogg)return}catch(t){console.error(t)}var a=this,r="li",o=GLOBAL.Et.gg.my,n="",c="",d="",p="";if(i){switch(e){case 1:r="li";break;case 2:r="li2";break;case 3:r="li3";break;case 4:r="li4"}if(n=o[r],!n)return;c=n?n.split("_")[0]:null,d=n?n.split("_")[1]:null}else d=a.getSogouGgIdForSpecialQid(),d?c="sogou":(c="baidu",d=s.shift());switch(c){case"gdt":p="gdt_"+(+new Date+Math.random().toString(10).substring(2,6)),l.append('<div class="gg-wrap"><iframe id="'+p+'" name="iframe" src="gg/gg_gdt.html?qid='+a.qid+"&uid="+a.userId+"&ggid="+d+"&iframeid="+p+'" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" width="100%" height="100%"></iframe></div>');break;case"baidu":$bdDom=$('<div class="bdgg-wrap" data-ggid="'+d+'"></div>'),l.append($bdDom),a.loadBaiduGg($bdDom,d);break;case"sogou":l.append('<div class="gg-wrap"><iframe src="gg/gg_sogou.html?ggid='+d+'" frameborder="0" scrolling="no" width="100%" height="78"></iframe></div>')}},getSogouGgIdForSpecialQid:function(){var e=GLOBAL.Et.onlySogouQid,t=0,a=e.length;for(t=0;t<a;t++)if(GLOBAL.Et.qid===e[t].qid)return e[t].ggid;return null},loadBaiduGg:function(e,t){var a=this,s='(window.cpro_mobile_slot = window.cpro_mobile_slot || []).push({id : "'+t+'",at:"3", pat:"21", ptLH:"30", tn:"template_inlay_all_mobile_lu_native", rss1:"#FFFFFF", titFF:"%E5%BE%AE%E8%BD%AF%E9%9B%85%E9%BB%91", titFS:"12", rss2:"#000000", ptFS:"17", ptFC:"#000000", ptFF:"%E5%BE%AE%E8%BD%AF%E9%9B%85%E9%BB%91", ptFW:"0", conpl:"15", conpr:"15", conpt:"8", conpb:"15", cpro_h:"140", ptn:"1", ptp:"0", itecpl:"10", piw:"0", pih:"0", ptDesc:"2", ptLogo:"0", ptLogoFS:"10", ptLogoBg:"#FFFFFF", ptLogoC:"#999999", ptLogoH:"0", ptLogoW:"0"})';e.append('<div id="cpro_'+t+'"></div><div class="line"></div>'),a.createScript(s,function(){a.getScript("http://jiaoben.eastday.com/cpro/ui/cm.js",function(){},$("#cpro_"+t)[0])},$("#cpro_"+t)[0])},createScript:function(e,t,a){if(e){var s=document.getElementsByTagName("head")[0],i=document.createElement("script");i.setAttribute("type","text/javascript"),i.innerHTML=e,a?a.appendChild(i):s.appendChild(i),t()}},getScript:function(e,t,a){var s=document.getElementsByTagName("head")[0],i=document.createElement("script");i.setAttribute("type","text/javascript"),i.setAttribute("src",e),a?a.appendChild(i):s.appendChild(i);var r=function(){"function"==typeof t&&t()};document.all?i.onreadystatechange=function(){"loaded"!==i.readyState&&"complete"!==i.readyState||r()}:i.onload=function(){r()}},cacheReadUrl:function(e){var t=this,a="";if(!t.existNewsReadUrl(e)){var s=f.get("read_url_all");if(s){for(s=s.split(",");s.length>=5;)s.shift();s.push(e),a=s.join(",")}else a=e;f.set("read_url_all",a,{exp:259200})}},existNewsReadUrl:function(e){var t=f.get("read_url_all");return!(!t||t.indexOf(e)===-1)},updateBtnStatus:function(){var e=$.trim(o.val());e?(r.addClass("cancel"),r.text("取消")):(r.removeClass("cancel"),r.text("搜索"))},cacheKw:function(){h&&f.set("search_kw",h,{exp:600})},clearContent:function(){l.empty(),c.hide(),n.show(),f["delete"]("search_content")},clearCaches:function(){f["delete"]("search_param_nlastcol"),f["delete"]("search_param_nstkey"),f["delete"]("search_param_vlastcol"),f["delete"]("search_param_vstkey"),f["delete"]("search_param_splitwordsarr")},loadSearchData:function(e){var t=this,s=f.get("search_param_nlastcol")?f.get("search_param_nlastcol"):"",i=f.get("search_param_nstkey")?f.get("search_param_nstkey"):"",r=f.get("search_param_vlastcol")?f.get("search_param_vlastcol"):"",o=f.get("search_param_vstkey")?f.get("search_param_vstkey"):"",l=f.get("search_param_splitwordsarr")?JSON.parse(f.get("search_param_splitwordsarr")):"",p=GLOBAL.Util.getPixel();$.ajax({url:a,dataType:"jsonp",timeout:6e3,data:{keywords:encodeURI(e),stkey_zixun:encodeURI(i),lastcol_zixun:s,stkey_video:encodeURI(o),lastcol_video:r,splitwordsarr:encodeURI(l),uid:GLOBAL.Et.uid,qid:GLOBAL.Et.qid,softtype:"news",softname:"eastday_wapnews",os_type:GLOBAL.Util.getOsType(),browser_type:GLOBAL.Util.getBrowserType(),pixel:p.w+"*"+p.h},jsonp:"jsonpcallback",beforeSend:function(){m=!1,d.show()},success:function(e){try{n.hide(),c.show(),t.generateDom(e)}catch(a){$(".J-no-news").remove(),d.before('<p class="J-no-news" style="text-align: center; font-size: 0.24rem; padding: 30px; color: #999;">抱歉，未找到相关新闻！</p>'),d.hide(),console.error(a)}},error:function(){console.error(arguments)},complete:function(){m=!0}})},getHandledArray:function(e,t){var a=[],s=e.length,i=t.length,r=_.chunk(e,3),o=_.chunk(t,2),n=r.length,c=o.length,l=0,d=_.max([n,c]);for(l=0;l<i;l++)t[l].isVideo=!0;if(s<=3){for(l=0;l<s;l++)a.push(e[l]);for(l=0;l<i;l++)a.push(t[l])}else if(s>3&&i<=2)for(a=_.concat(a,r[0]),a=_.concat(a,o[0]),l=1;l<n;l++)a=_.concat(a,r[l]);else if(s>3&&i>2)for(a=_.concat(a,r[0]),a=_.concat(a,o[0]),l=1;l<d;l++)a=_.concat(a,r[l]?r[l]:[]),a=_.concat(a,o[l]?o[l]:[]);return a},generateDom:function(e){var t=this,a=e.splitword,s=e.splitwordsarr,i=e.zixun,r=e.video,o=i.stkey,n=i.lastcol,c=r.stkey,d=r.lastcol;p||(p=0);for(var g=t.getHandledArray(i.data,r.data),h=0;h<g.length;h++){var m=g[h],u=m.url,v=m.title,w=m.date,_=m.ispicnews,y=m.imgstr,b=m.isVideo,L=Number(m.comment_count?m.comment_count:0),k=Number(m.urlpv?m.urlpv:0),S=y.length,B="",x="",F=m.source;v=t.getNewStr(v,a),u+="?idx="+p++ +"&fr=search",w=w.substring(5,w.length-1).replace("月","-"),0!==k&&(x='<em class="tag tag-view">'+GLOBAL.Util.getSpecialCountStr(k)+(b?"观看":"阅读")+"</em>",B='<em class="tag tag-com">'+GLOBAL.Util.getSpecialCountStr(L)+"评论</em>"),b?l.append('<section class="news-item news-img1 news-video"><div class="one-px-border"></div><a href="'+u+'" class="news-link"><div class="info"><h3 class="title dotdot line3">'+v+'</h3><p class="tags"><em class="tag tag-video">视频</em>'+B+x+'<em class="tag tag-src">'+F+'</em></p></div><div class="img img-bg"><img class="image" src="'+y[0].src+'"><span class="video-btn"></span></div></a></section>'):S>=3?l.append('<section class="news-item news-img3"><div class="one-px-border"></div><a href="'+u+'" class="news-link"><div class="info"><h3 class="title dotdot line3">'+v+'</h3></div><div class="img"><div class="img-wrap img-bg"><img class="image" src="'+y[0].src+'"></div><div class="img-wrap img-bg"><img class="image" src="'+y[1].src+'"></div><div class="img-wrap img-bg"><img class="image" src="'+y[2].src+'"></div></div><p class="tags"><em class="tag tag-time">'+w+"</em>"+B+x+'<em class="tag tag-src">'+F+"</em></p></a></section>"):S>=1?l.append('<section class="news-item news-img1"><div class="one-px-border"></div><a href="'+u+'" class="news-link"><div class="info"><h3 class="title dotdot line3">'+v+'</h3><p class="tags"><em class="tag tag-time">'+w+"</em>"+B+x+'<em class="tag tag-src">'+F+'</em></p></div><div class="img img-bg"><img class="image" src="'+y[0].src+'"></div></a></section>'):"-1"==_&&l.append('<section class="news-item news-txt"><div class="one-px-border"></div><a href="'+u+'" class="news-link"><div class="info"><h3 class="title dotdot line3">'+v+'</h3><p class="tags"><em class="tag tag-time">'+w+"</em>"+B+x+'<em class="tag tag-src">'+F+"</em></p></div></a></section>");try{4===h?t.insertGgForPullUp(1):9===h?t.insertGgForPullUp(2):14===h?t.insertGgForPullUp(3):19===h&&t.insertGgForPullUp(4)}catch(G){console.error("insertGgForPullUp has error：\n",G)}}f.set("search_param_nstkey",o),f.set("search_param_nlastcol",n),f.set("search_param_vstkey",c),f.set("search_param_vlastcol",d),f.set("search_param_splitwordsarr",JSON.stringify(s)),f.set("search_content",l.html(),{exp:600}),t.hideOfShowLoading()},hideOfShowLoading:function(){d.offset().top<GLOBAL.Util.getClientHeight()&&d.hide()},loadHotWords:function(){$.ajax({type:"GET",url:t,dataType:"jsonp",data:{type:"now"},jsonp:"jsonpcallback",timeout:5e3,success:function(e){for(var t=e.ret,a="<h3>热门搜索</h3>",s=0;s<10;s++)a+='<p><a href="javascript:;">'+t[s]+"</a></p>";n.html(a),f.set("search_hotwords",a,{exp:300})},error:function(){console.error(arguments)}})},getNewStr:function(e,t,a){if(!e||"string"!=typeof e)return"";t instanceof Array&&0!==t.length||(t=[$.trim(o.val())]);var s=this,i=t.length;if(t.sort(function(e,t){return t.length-e.length}),a||(a=0),a===i||".."===t[a])return e;var r=new RegExp(t[a],"gi"),n=e,c=n.toLowerCase().indexOf(t[a].toLowerCase()),l=e.substring(c,c+t[a].length);return s.getNewStr(e.replace(r,"<em>"+l+"</em>"),t,++a)}},new e});